### 常见的内存分配器

- jemalloc 
- ptmalloc
- tcmalloc

#### 区别

ptmalloc 是基于 glibc 实现的内存分配器，它是一个标准实现，所以兼容性较好。pt 表示 per thread 的意思。当然 ptmalloc 确实在多线程的性能优化上下了很多功夫。由于过于考虑性能问题，多线程之间内存无法实现共享，只能每个线程都独立使用各自的内存，所以在内存开销上是有很大浪费的。

tcmalloc 出身于 Google，全称是 thread-caching malloc，所以 tcmalloc 最大的特点是带有线程缓存，tcmalloc 非常出名，目前在 Chrome、Safari 等知名产品中都有所应有。tcmalloc 为每个线程分配了一个局部缓存，对于小对象的分配，可以直接由线程局部缓存来完成，对于大对象的分配场景，tcmalloc 尝试采用自旋锁来减少多线程的锁竞争问题。

jemalloc 借鉴了 tcmalloc 优秀的设计思路，所以在架构设计方面两者有很多相似之处，同样都包含 thread cache 的特性。但是 jemalloc 在设计上比 ptmalloc 和 tcmalloc 都要复杂，jemalloc 将内存分配粒度划分为 Small、Large、Huge 三个分类，并记录了很多 meta 数据，所以在空间占用上要略多于 tcmalloc，不过在大内存分配的场景，jemalloc 的内存碎片要少于 tcmalloc。tcmalloc 内部采用红黑树管理内存块和分页，Huge 对象通过红黑树查找索引数据可以控制在指数级时间。

#### 目标

1. 高效的内存分配和回收，提升单线程或者多线程场景下的性能。
2. 减少内存碎片，包括内部碎片和外部碎片，提高内存的有效利用率。

### 常用的内存分配算法

1. 动态内存分配——使用空闲链表将内存中可以使用的内存用链表连接在一起，每次程序运行的时候，计算需要的内存大小，从空闲链表中按照策略进行内存分配

2. 伙伴算法——将内存切分为2^0个Page, 2^1个Page, 2^2 个Page...的小块，1个Page为1KB，相同大小的小块用链表连接起来。比如对于申请12KB的内存，查看2^4的链表是否有空闲的小块，如果有则直接分配，如果无则查找2^5的链表中是否有空闲的小块，如果有则将其切分为2块2^4大小的小块，将其中一块分配给程序，其中一块放置在2^4空闲链表中

   - 伙伴算法能够有效减少外部碎片，但是容易导致大量的内部碎片

3. Slab算法——伙伴算法最小分配单位为Page，对于小内存分配的场景性能不好，因此Slab算法对其进行了优化

   

























